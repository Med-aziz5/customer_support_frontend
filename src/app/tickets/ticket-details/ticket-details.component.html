<div *ngIf="loading">Loading ticket details...</div>

<div *ngIf="!loading">
  <h2>Ticket #{{ ticketId }}</h2>

  <!-- Comments Section -->
  <section class="comments-section">
    <h3>Comments</h3>
    <div *ngFor="let c of comments" class="comment">
      <p>
        <strong>
          {{ c.author?.email || 'Unknown' }} ({{ c.author?.role || 'N/A' }})
        </strong>
        : {{ c.content }}
      </p>
      <small>{{ c.created_at | date: 'short' }}</small>
    </div>

    <!-- Comment form (all logged-in users can comment) -->
    <div *ngIf="auth.getUser() as user">
      <textarea [formControl]="newComment" placeholder="Add a comment"></textarea>
      <button (click)="addComment()">Submit Comment</button>
    </div>
  </section>

  <!-- Notes Section (Agent/Admin only) -->
  <section *ngIf="role === 'AGENT' || role === 'ADMIN'" class="notes-section">
    <h3>Notes </h3>
    <div *ngFor="let n of notes" class="note">
      <p>{{ n.content }}</p>
      <small>
        - {{ n.agent?.email || 'Unknown' }}
      </small>
    </div>

    <!-- Note form (only Agent/Admin) -->
    <textarea [formControl]="newNote" placeholder="Add a note"></textarea>
    <button (click)="addNote()">Submit Note</button>
  </section>

  <!-- History Section -->
  <section class="history-section">
    <h3>Ticket History</h3>
    <div *ngFor="let h of history" class="history-entry">
      <p>
        {{ h.user?.email || 'Unknown' }} ({{ h.user?.role || 'N/A' }})
        - {{ h.action }}
      </p>
      <small>{{ h.created_at | date: 'short' }}</small>
    </div>
  </section>
</div>
