<!-- CLIENT VIEW -->
<div *ngIf="role === 'CLIENT'" class="client-tickets">

  <!-- Show loading or empty state -->
  <div *ngIf="loading">Loading tickets...</div>
  <div *ngIf="!loading && tickets.length === 0">No tickets found.</div>

  <!-- Create Ticket button -->
  <button routerLink="/tickets/create">Create Ticket</button>

  <div *ngFor="let ticket of tickets" class="ticket-card">
    <h3>{{ ticket.title }}</h3>
    <p>{{ ticket.description }}</p>
    <p><strong>Category:</strong> {{ ticket.category }}</p>
    <p><strong>Priority:</strong> {{ ticket.priority }}</p>
    <p><strong>Status:</strong> {{ ticket.status }}</p>

    <button (click)="editTicket(ticket.id)">Edit</button>

    <!-- Request Meeting button -->
    <button 
      (click)="requestMeeting(ticket.id)" 
      [disabled]="ticket.status === 'CLOSED' || requestedMeetings.has(ticket.id)">
      {{ requestedMeetings.has(ticket.id) ? 'Meeting Requested' : 'Request Meeting' }}
    </button>
  </div>
</div>

<!-- AGENT / ADMIN VIEW -->
<div *ngIf="role !== 'CLIENT'" class="agent-admin-tickets">

  <!-- Show success message -->
  <div *ngIf="message" class="success-message">{{ message }}</div>

  <!-- Toggle checkbox -->
  <div class="filter-bar">
    <label>
      <input type="checkbox" [(ngModel)]="showAssignedOnly" (change)="toggleAssignedTickets()" />
      Show only my tickets
    </label>
  </div>

  <!-- Loading / Empty -->
  <div *ngIf="loading">Loading tickets...</div>
  <div *ngIf="!loading && tickets.length === 0">No tickets found.</div>

  <table *ngIf="!loading && tickets.length > 0">
    <thead>
      <tr>
        <th>Title</th>
        <th>Description</th>
        <th>Category</th>
        <th>Priority</th>
        <th>Status</th>
        <th>User ID</th>
        <th>Assigned To</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let ticket of tickets">
        <td>{{ ticket.title }}</td>
        <td>{{ ticket.description }}</td>
        <td>{{ ticket.category }}</td>
        <td>{{ ticket.priority }}</td>
        <td>{{ ticket.status }}</td>
        <td>{{ ticket.user_id }}</td>
        <td>{{ ticket.assigned_to || 'Unassigned' }}</td>
        <td>
          <!-- Assign to self -->
          <button *ngIf="role === 'AGENT' || role === 'ADMIN'" (click)="assignToSelf(ticket.id)">
            Assign to Self
          </button>

          <!-- Assign to another agent (ADMIN only) -->
          <div *ngIf="role === 'ADMIN'" class="assign-admin">
            <input type="number" placeholder="Agent ID" [formControl]="assignForm.controls['agentId']"/>
            <button (click)="assignToAgent(ticket.id)">Assign</button>
          </div>
        </td>
        <td>
          <!-- Delete button for Admin -->
          <button *ngIf="role === 'ADMIN'" (click)="deleteTicket(ticket.id)">
            Delete
          </button>
        </td>
      </tr>
    </tbody>
  </table>
</div>
